class Gui.Views.Project extends Backbone.View
  className: 'project'

  menuTemplate: JST["templates/project_menu"]
  menuEl: null

  blendFunctionView: null
  finalTouchFunctionView: null

  imageViews: null
  previewView: null

  selectedPoints: null

  initialize: =>
    @$menuEl = $('<div />').addClass('project-menu')
    @menuEl = @$menuEl[0]
    @$menuEl.on 'click', '[data-action]', @clickHandler

    @blendFunctionView = new Gui.Views.Popups.EditFunction(model: @model, name: 'blend_function')
    @finalTouchFunctionView = new Gui.Views.Popups.EditFunction(model: @model, name: 'final_touch_function')

    @model.morpher.on "resize", @updateImagesSize
    @model.morpher.on "load", @loadHandler

    @previewView = new Gui.Views.Tile()

    @selectedPoints = []

    @imageViews = []
    @model.images.bind 'add', @addImageView
    @model.images.bind 'reset', @addAllImageViews
    @model.images.bind 'remove', @removeImageView


  # public methods

  save: =>
    @model.save()

  show: =>
    @$menuEl.addClass('visible')
    @$el.addClass('visible')

  hide: =>
    @$menuEl.removeClass('visible')
    @$el.removeClass('visible')

  remove: =>
    @$menuEl.remove()
    super

  export: =>
    popup = Gui.Views.Popup.show("templates/popups/code", code: @model.getCode())
    popup.$el.find('textarea.code').focus().select()

  addPlaceholderPointsFive: =>
    @model.morpher.fromJSON({
      "images": [
        {
          "points": [
            { "x": 500, "y": 500 }, { "x": 550, "y": 500 }, { "x": 600, "y": 500 }, { "x": 650, "y": 500 }, { "x": 700, "y": 500 },
            { "x": 500, "y": 550 }, { "x": 550, "y": 550 }, { "x": 600, "y": 550 }, { "x": 650, "y": 550 }, { "x": 700, "y": 550 },
            { "x": 500, "y": 600 }, { "x": 550, "y": 600 }, { "x": 600, "y": 600 }, { "x": 650, "y": 600 }, { "x": 700, "y": 600 },
            { "x": 500, "y": 650 }, { "x": 550, "y": 650 }, { "x": 600, "y": 650 }, { "x": 650, "y": 650 }, { "x": 700, "y": 650 },
            { "x": 500, "y": 700 }, { "x": 550, "y": 700 }, { "x": 600, "y": 700 }, { "x": 650, "y": 700 }, { "x": 700, "y": 700 }
          ]
        },
        {
          "points": [
            { "x": 500, "y": 500 }, { "x": 550, "y": 500 }, { "x": 600, "y": 500 }, { "x": 650, "y": 500 }, { "x": 700, "y": 500 },
            { "x": 500, "y": 550 }, { "x": 550, "y": 550 }, { "x": 600, "y": 550 }, { "x": 650, "y": 550 }, { "x": 700, "y": 550 },
            { "x": 500, "y": 600 }, { "x": 550, "y": 600 }, { "x": 600, "y": 600 }, { "x": 650, "y": 600 }, { "x": 700, "y": 600 },
            { "x": 500, "y": 650 }, { "x": 550, "y": 650 }, { "x": 600, "y": 650 }, { "x": 650, "y": 650 }, { "x": 700, "y": 650 },
            { "x": 500, "y": 700 }, { "x": 550, "y": 700 }, { "x": 600, "y": 700 }, { "x": 650, "y": 700 }, { "x": 700, "y": 700 }
          ]
        }
      ],
      "triangles": [
        [0,1,5],[1,6,5],[1,2,6],[2,7,6],[2,3,7],[3,8,7],[3,4,8],[4,9,8],
        [5,6,10],[6,11,10],[6,7,11],[7,12,11],[7,8,12],[8,13,12],[8,9,13],[9,14,13],
        [10,11,15],[11,16,15],[11,12,16],[12,17,16],[12,13,17],[13,18,17],[13,14,18],[14,19,18],
        [15,16,20],[16,21,20],[16,17,21],[17,22,21],[17,18,22],[18,23,22],[18,19,23],[19,24,23]
      ]
    })

  addPlaceholderPointsSix: =>
    @model.morpher.fromJSON({
      "images": [
        {
          "points": [
            { "x": 500, "y": 500 }, { "x": 550, "y": 500 }, { "x": 600, "y": 500 }, { "x": 650, "y": 500 }, { "x": 700, "y": 500 }, { "x": 750, "y": 500 },
            { "x": 500, "y": 550 }, { "x": 550, "y": 550 }, { "x": 600, "y": 550 }, { "x": 650, "y": 550 }, { "x": 700, "y": 550 }, { "x": 750, "y": 550 },
            { "x": 500, "y": 600 }, { "x": 550, "y": 600 }, { "x": 600, "y": 600 }, { "x": 650, "y": 600 }, { "x": 700, "y": 600 }, { "x": 750, "y": 600 },
            { "x": 500, "y": 650 }, { "x": 550, "y": 650 }, { "x": 600, "y": 650 }, { "x": 650, "y": 650 }, { "x": 700, "y": 650 }, { "x": 750, "y": 650 },
            { "x": 500, "y": 700 }, { "x": 550, "y": 700 }, { "x": 600, "y": 700 }, { "x": 650, "y": 700 }, { "x": 700, "y": 700 }, { "x": 750, "y": 700 },
            { "x": 500, "y": 750 }, { "x": 550, "y": 750 }, { "x": 600, "y": 750 }, { "x": 650, "y": 750 }, { "x": 700, "y": 750 }, { "x": 750, "y": 750 }
          ]
        },
        {
          "points": [
            { "x": 500, "y": 500 }, { "x": 550, "y": 500 }, { "x": 600, "y": 500 }, { "x": 650, "y": 500 }, { "x": 700, "y": 500 }, { "x": 750, "y": 500 },
            { "x": 500, "y": 550 }, { "x": 550, "y": 550 }, { "x": 600, "y": 550 }, { "x": 650, "y": 550 }, { "x": 700, "y": 550 }, { "x": 750, "y": 550 },
            { "x": 500, "y": 600 }, { "x": 550, "y": 600 }, { "x": 600, "y": 600 }, { "x": 650, "y": 600 }, { "x": 700, "y": 600 }, { "x": 750, "y": 600 },
            { "x": 500, "y": 650 }, { "x": 550, "y": 650 }, { "x": 600, "y": 650 }, { "x": 650, "y": 650 }, { "x": 700, "y": 650 }, { "x": 750, "y": 650 },
            { "x": 500, "y": 700 }, { "x": 550, "y": 700 }, { "x": 600, "y": 700 }, { "x": 650, "y": 700 }, { "x": 700, "y": 700 }, { "x": 750, "y": 700 },
            { "x": 500, "y": 750 }, { "x": 550, "y": 750 }, { "x": 600, "y": 750 }, { "x": 650, "y": 750 }, { "x": 700, "y": 750 }, { "x": 750, "y": 750 }
          ]
        }
      ],
      "triangles": [
        [0, 1, 6], [1, 7, 6], [1, 2, 7], [2, 8, 7], [2, 3, 8], [3, 9, 8], [3, 4, 9], [4, 10, 9], [4, 5, 10], [5, 11, 10],
        [6, 7, 12], [7, 13, 12], [7, 8, 13], [8, 14, 13], [8, 9, 14], [9, 15, 14], [9, 10, 15], [10, 16, 15], [10, 11, 16], [11, 17, 16],
        [12, 13, 18], [13, 19, 18], [13, 14, 19], [14, 20, 19], [14, 15, 20], [15, 21, 20], [15, 16, 21], [16, 22, 21], [16, 17, 22], [17, 23, 22],
        [18, 19, 24], [19, 25, 24], [19, 20, 25], [20, 26, 25], [20, 21, 26], [21, 27, 26], [21, 22, 27], [22, 28, 27], [22, 23, 28], [23, 29, 28],
        [24, 25, 30], [25, 31, 30], [25, 26, 31], [26, 32, 31], [26, 27, 32], [27, 33, 32], [27, 28, 33], [28, 34, 33], [28, 29, 34], [29, 35, 34]
      ]
    })

  addPlaceholderPointsSeven: =>
    @model.morpher.fromJSON({
      "images": [
        {
          "points": [
            { "x": 500, "y": 500 }, { "x": 550, "y": 500 }, { "x": 600, "y": 500 }, { "x": 650, "y": 500 }, { "x": 700, "y": 500 }, { "x": 750, "y": 500 }, { "x": 800, "y": 500 },
            { "x": 500, "y": 550 }, { "x": 550, "y": 550 }, { "x": 600, "y": 550 }, { "x": 650, "y": 550 }, { "x": 700, "y": 550 }, { "x": 750, "y": 550 }, { "x": 800, "y": 550 },
            { "x": 500, "y": 600 }, { "x": 550, "y": 600 }, { "x": 600, "y": 600 }, { "x": 650, "y": 600 }, { "x": 700, "y": 600 }, { "x": 750, "y": 600 }, { "x": 800, "y": 600 },
            { "x": 500, "y": 650 }, { "x": 550, "y": 650 }, { "x": 600, "y": 650 }, { "x": 650, "y": 650 }, { "x": 700, "y": 650 }, { "x": 750, "y": 650 }, { "x": 800, "y": 650 },
            { "x": 500, "y": 700 }, { "x": 550, "y": 700 }, { "x": 600, "y": 700 }, { "x": 650, "y": 700 }, { "x": 700, "y": 700 }, { "x": 750, "y": 700 }, { "x": 800, "y": 700 },
            { "x": 500, "y": 750 }, { "x": 550, "y": 750 }, { "x": 600, "y": 750 }, { "x": 650, "y": 750 }, { "x": 700, "y": 750 }, { "x": 750, "y": 750 }, { "x": 800, "y": 750 },
            { "x": 500, "y": 800 }, { "x": 550, "y": 800 }, { "x": 600, "y": 800 }, { "x": 650, "y": 800 }, { "x": 700, "y": 800 }, { "x": 750, "y": 800 }, { "x": 800, "y": 800 }
          ]
        },
        {
          "points": [
            { "x": 500, "y": 500 }, { "x": 550, "y": 500 }, { "x": 600, "y": 500 }, { "x": 650, "y": 500 }, { "x": 700, "y": 500 }, { "x": 750, "y": 500 }, { "x": 800, "y": 500 },
            { "x": 500, "y": 550 }, { "x": 550, "y": 550 }, { "x": 600, "y": 550 }, { "x": 650, "y": 550 }, { "x": 700, "y": 550 }, { "x": 750, "y": 550 }, { "x": 800, "y": 550 },
            { "x": 500, "y": 600 }, { "x": 550, "y": 600 }, { "x": 600, "y": 600 }, { "x": 650, "y": 600 }, { "x": 700, "y": 600 }, { "x": 750, "y": 600 }, { "x": 800, "y": 600 },
            { "x": 500, "y": 650 }, { "x": 550, "y": 650 }, { "x": 600, "y": 650 }, { "x": 650, "y": 650 }, { "x": 700, "y": 650 }, { "x": 750, "y": 650 }, { "x": 800, "y": 650 },
            { "x": 500, "y": 700 }, { "x": 550, "y": 700 }, { "x": 600, "y": 700 }, { "x": 650, "y": 700 }, { "x": 700, "y": 700 }, { "x": 750, "y": 700 }, { "x": 800, "y": 700 },
            { "x": 500, "y": 750 }, { "x": 550, "y": 750 }, { "x": 600, "y": 750 }, { "x": 650, "y": 750 }, { "x": 700, "y": 750 }, { "x": 750, "y": 750 }, { "x": 800, "y": 750 },
            { "x": 500, "y": 800 }, { "x": 550, "y": 800 }, { "x": 600, "y": 800 }, { "x": 650, "y": 800 }, { "x": 700, "y": 800 }, { "x": 750, "y": 800 }, { "x": 800, "y": 800 }
          ]
        }
      ],
      "triangles": [
        [0, 1, 7], [1, 8, 7], [1, 2, 8], [2, 9, 8], [2, 3, 9], [3, 10, 9], [3, 4, 10], [4, 11, 10], [4, 5, 11], [5, 12, 11], [5, 6, 12], [6, 13, 12],
        [7, 8, 14], [8, 15, 14], [8, 9, 15], [9, 16, 15], [9, 10, 16], [10, 17, 16], [10, 11, 17], [11, 18, 17], [11, 12, 18], [12, 19, 18], [12, 13, 19], [13, 20, 19],
        [14, 15, 21], [15, 22, 21], [15, 16, 22], [16, 23, 22], [16, 17, 23], [17, 24, 23], [17, 18, 24], [18, 25, 24], [18, 19, 25], [19, 26, 25], [19, 20, 26], [20, 27, 26],
        [21, 22, 28], [22, 29, 28], [22, 23, 29], [23, 30, 29], [23, 24, 30], [24, 31, 30], [24, 25, 31], [25, 32, 31], [25, 26, 32], [26, 33, 32], [26, 27, 33], [27, 34, 33],
        [28, 29, 35], [29, 36, 35], [29, 30, 36], [30, 37, 36], [30, 31, 37], [31, 38, 37], [31, 32, 38], [32, 39, 38], [32, 33, 39], [33, 40, 39], [33, 34, 40], [34, 41, 40],
        [35, 36, 42], [36, 43, 42], [36, 37, 43], [37, 44, 43], [37, 38, 44], [38, 45, 44], [38, 39, 45], [39, 46, 45], [39, 40, 46], [40, 47, 46], [40, 41, 47], [41, 48, 47]
      ]
    })

  addPlaceholderPointsTwelveSeven: =>
    @model.morpher.fromJSON({
      "images": [
        {
          "points": [
            { "x": 500, "y": 500 }, { "x": 525, "y": 500 }, { "x": 550, "y": 500 }, { "x": 575, "y": 500 }, { "x": 600, "y": 500 }, { "x": 625, "y": 500 }, { "x": 650, "y": 500 },
            { "x": 675, "y": 500 }, { "x": 700, "y": 500 }, { "x": 725, "y": 500 }, { "x": 750, "y": 500 }, { "x": 775, "y": 500 },
            { "x": 500, "y": 550 }, { "x": 525, "y": 550 }, { "x": 550, "y": 550 }, { "x": 575, "y": 550 }, { "x": 600, "y": 550 }, { "x": 625, "y": 550 }, { "x": 650, "y": 550 },
            { "x": 675, "y": 550 }, { "x": 700, "y": 550 }, { "x": 725, "y": 550 }, { "x": 750, "y": 550 }, { "x": 775, "y": 550 },
            { "x": 500, "y": 600 }, { "x": 525, "y": 600 }, { "x": 550, "y": 600 }, { "x": 575, "y": 600 }, { "x": 600, "y": 600 }, { "x": 625, "y": 600 }, { "x": 650, "y": 600 },
            { "x": 675, "y": 600 }, { "x": 700, "y": 600 }, { "x": 725, "y": 600 }, { "x": 750, "y": 600 }, { "x": 775, "y": 600 },
            { "x": 500, "y": 650 }, { "x": 525, "y": 650 }, { "x": 550, "y": 650 }, { "x": 575, "y": 650 }, { "x": 600, "y": 650 }, { "x": 625, "y": 650 }, { "x": 650, "y": 650 },
            { "x": 675, "y": 650 }, { "x": 700, "y": 650 }, { "x": 725, "y": 650 }, { "x": 750, "y": 650 }, { "x": 775, "y": 650 },
            { "x": 500, "y": 700 }, { "x": 525, "y": 700 }, { "x": 550, "y": 700 }, { "x": 575, "y": 700 }, { "x": 600, "y": 700 }, { "x": 625, "y": 700 }, { "x": 650, "y": 700 },
            { "x": 675, "y": 700 }, { "x": 700, "y": 700 }, { "x": 725, "y": 700 }, { "x": 750, "y": 700 }, { "x": 775, "y": 700 },
            { "x": 500, "y": 750 }, { "x": 525, "y": 750 }, { "x": 550, "y": 750 }, { "x": 575, "y": 750 }, { "x": 600, "y": 750 }, { "x": 625, "y": 750 }, { "x": 650, "y": 750 },
            { "x": 675, "y": 750 }, { "x": 700, "y": 750 }, { "x": 725, "y": 750 }, { "x": 750, "y": 750 }, { "x": 775, "y": 750 },
            { "x": 500, "y": 800 }, { "x": 525, "y": 800 }, { "x": 550, "y": 800 }, { "x": 575, "y": 800 }, { "x": 600, "y": 800 }, { "x": 625, "y": 800 }, { "x": 650, "y": 800 },
            { "x": 675, "y": 800 }, { "x": 700, "y": 800 }, { "x": 725, "y": 800 }, { "x": 750, "y": 800 }, { "x": 775, "y": 800 }
          ]
        },
        {
          "points": [
            { "x": 500, "y": 500 }, { "x": 525, "y": 500 }, { "x": 550, "y": 500 }, { "x": 575, "y": 500 }, { "x": 600, "y": 500 }, { "x": 625, "y": 500 }, { "x": 650, "y": 500 },
            { "x": 675, "y": 500 }, { "x": 700, "y": 500 }, { "x": 725, "y": 500 }, { "x": 750, "y": 500 }, { "x": 775, "y": 500 },
            { "x": 500, "y": 550 }, { "x": 525, "y": 550 }, { "x": 550, "y": 550 }, { "x": 575, "y": 550 }, { "x": 600, "y": 550 }, { "x": 625, "y": 550 }, { "x": 650, "y": 550 },
            { "x": 675, "y": 550 }, { "x": 700, "y": 550 }, { "x": 725, "y": 550 }, { "x": 750, "y": 550 }, { "x": 775, "y": 550 },
            { "x": 500, "y": 600 }, { "x": 525, "y": 600 }, { "x": 550, "y": 600 }, { "x": 575, "y": 600 }, { "x": 600, "y": 600 }, { "x": 625, "y": 600 }, { "x": 650, "y": 600 },
            { "x": 675, "y": 600 }, { "x": 700, "y": 600 }, { "x": 725, "y": 600 }, { "x": 750, "y": 600 }, { "x": 775, "y": 600 },
            { "x": 500, "y": 650 }, { "x": 525, "y": 650 }, { "x": 550, "y": 650 }, { "x": 575, "y": 650 }, { "x": 600, "y": 650 }, { "x": 625, "y": 650 }, { "x": 650, "y": 650 },
            { "x": 675, "y": 650 }, { "x": 700, "y": 650 }, { "x": 725, "y": 650 }, { "x": 750, "y": 650 }, { "x": 775, "y": 650 },
            { "x": 500, "y": 700 }, { "x": 525, "y": 700 }, { "x": 550, "y": 700 }, { "x": 575, "y": 700 }, { "x": 600, "y": 700 }, { "x": 625, "y": 700 }, { "x": 650, "y": 700 },
            { "x": 675, "y": 700 }, { "x": 700, "y": 700 }, { "x": 725, "y": 700 }, { "x": 750, "y": 700 }, { "x": 775, "y": 700 },
            { "x": 500, "y": 750 }, { "x": 525, "y": 750 }, { "x": 550, "y": 750 }, { "x": 575, "y": 750 }, { "x": 600, "y": 750 }, { "x": 625, "y": 750 }, { "x": 650, "y": 750 },
            { "x": 675, "y": 750 }, { "x": 700, "y": 750 }, { "x": 725, "y": 750 }, { "x": 750, "y": 750 }, { "x": 775, "y": 750 },
            { "x": 500, "y": 800 }, { "x": 525, "y": 800 }, { "x": 550, "y": 800 }, { "x": 575, "y": 800 }, { "x": 600, "y": 800 }, { "x": 625, "y": 800 }, { "x": 650, "y": 800 },
            { "x": 675, "y": 800 }, { "x": 700, "y": 800 }, { "x": 725, "y": 800 }, { "x": 750, "y": 800 }, { "x": 775, "y": 800 }
          ]
        }
      ],
      "triangles": [
        [0,1,12],[1,13,12],[1,2,13],[2,14,13],[2,3,14],[3,15,14],[3,4,15],[4,16,15],[4,5,16],[5,17,16],[5,6,17],[6,18,17],[6,7,18],[7,19,18],[7,8,19],[8,20,19],[8,9,20],[9,21,20],[9,10,21],[10,22,21],[10,11,22],[11,23,22],
        [12,13,24],[13,25,24],[13,14,25],[14,26,25],[14,15,26],[15,27,26],[15,16,27],[16,28,27],[16,17,28],[17,29,28],[17,18,29],[18,30,29],[18,19,30],[19,31,30],[19,20,31],[20,32,31],[20,21,32],[21,33,32],[21,22,33],[22,34,33],[22,23,34],[23,35,34],
        [24,25,36],[25,37,36],[25,26,37],[26,38,37],[26,27,38],[27,39,38],[27,28,39],[28,40,39],[28,29,40],[29,41,40],[29,30,41],[30,42,41],[30,31,42],[31,43,42],[31,32,43],[32,44,43],[32,33,44],[33,45,44],[33,34,45],[34,46,45],[34,35,46],[35,47,46],
        [36,37,48],[37,49,48],[37,38,49],[38,50,49],[38,39,50],[39,51,50],[39,40,51],[40,52,51],[40,41,52],[41,53,52],[41,42,53],[42,54,53],[42,43,54],[43,55,54],[43,44,55],[44,56,55],[44,45,56],[45,57,56],[45,46,57],[46,58,57],[46,47,58],[47,59,58],
        [48,49,60],[49,61,60],[49,50,61],[50,62,61],[50,51,62],[51,63,62],[51,52,63],[52,64,63],[52,53,64],[53,65,64],[53,54,65],[54,66,65],[54,55,66],[55,67,66],[55,56,67],[56,68,67],[56,57,68],[57,69,68],[57,58,69],[58,70,69],[58,59,70],[59,71,70],
        [60,61,72],[61,73,72],[61,62,73],[62,74,73],[62,63,74],[63,75,74],[63,64,75],[64,76,75],[64,65,76],[65,77,76],[65,66,77],[66,78,77],[66,67,78],[67,79,78],[67,68,79],[68,80,79],[68,69,80],[69,81,80],[69,70,81],[70,82,81],[70,71,82],[71,83,82]
      ]
    })

  addPlaceholderPointsFourteenSeven: =>
    @model.morpher.fromJSON({
      "images": [
        {
          "points": [
            { "x": 500, "y": 500 }, { "x": 525, "y": 500 }, { "x": 550, "y": 500 }, { "x": 575, "y": 500 }, { "x": 600, "y": 500 }, { "x": 625, "y": 500 }, { "x": 650, "y": 500 },
            { "x": 675, "y": 500 }, { "x": 700, "y": 500 }, { "x": 725, "y": 500 }, { "x": 750, "y": 500 }, { "x": 775, "y": 500 }, { "x": 800, "y": 500 }, { "x": 825, "y": 500 },
            { "x": 500, "y": 550 }, { "x": 525, "y": 550 }, { "x": 550, "y": 550 }, { "x": 575, "y": 550 }, { "x": 600, "y": 550 }, { "x": 625, "y": 550 }, { "x": 650, "y": 550 },
            { "x": 675, "y": 550 }, { "x": 700, "y": 550 }, { "x": 725, "y": 550 }, { "x": 750, "y": 550 }, { "x": 775, "y": 550 }, { "x": 800, "y": 550 }, { "x": 825, "y": 550 },
            { "x": 500, "y": 600 }, { "x": 525, "y": 600 }, { "x": 550, "y": 600 }, { "x": 575, "y": 600 }, { "x": 600, "y": 600 }, { "x": 625, "y": 600 }, { "x": 650, "y": 600 },
            { "x": 675, "y": 600 }, { "x": 700, "y": 600 }, { "x": 725, "y": 600 }, { "x": 750, "y": 600 }, { "x": 775, "y": 600 }, { "x": 800, "y": 600 }, { "x": 825, "y": 600 },
            { "x": 500, "y": 650 }, { "x": 525, "y": 650 }, { "x": 550, "y": 650 }, { "x": 575, "y": 650 }, { "x": 600, "y": 650 }, { "x": 625, "y": 650 }, { "x": 650, "y": 650 },
            { "x": 675, "y": 650 }, { "x": 700, "y": 650 }, { "x": 725, "y": 650 }, { "x": 750, "y": 650 }, { "x": 775, "y": 650 }, { "x": 800, "y": 650 }, { "x": 825, "y": 650 },
            { "x": 500, "y": 700 }, { "x": 525, "y": 700 }, { "x": 550, "y": 700 }, { "x": 575, "y": 700 }, { "x": 600, "y": 700 }, { "x": 625, "y": 700 }, { "x": 650, "y": 700 },
            { "x": 675, "y": 700 }, { "x": 700, "y": 700 }, { "x": 725, "y": 700 }, { "x": 750, "y": 700 }, { "x": 775, "y": 700 }, { "x": 800, "y": 700 }, { "x": 825, "y": 700 },
            { "x": 500, "y": 750 }, { "x": 525, "y": 750 }, { "x": 550, "y": 750 }, { "x": 575, "y": 750 }, { "x": 600, "y": 750 }, { "x": 625, "y": 750 }, { "x": 650, "y": 750 },
            { "x": 675, "y": 750 }, { "x": 700, "y": 750 }, { "x": 725, "y": 750 }, { "x": 750, "y": 750 }, { "x": 775, "y": 750 }, { "x": 800, "y": 750 }, { "x": 825, "y": 750 },
            { "x": 500, "y": 800 }, { "x": 525, "y": 800 }, { "x": 550, "y": 800 }, { "x": 575, "y": 800 }, { "x": 600, "y": 800 }, { "x": 625, "y": 800 }, { "x": 650, "y": 800 },
            { "x": 675, "y": 800 }, { "x": 700, "y": 800 }, { "x": 725, "y": 800 }, { "x": 750, "y": 800 }, { "x": 775, "y": 800 }, { "x": 800, "y": 800 }, { "x": 825, "y": 800 }
          ]
        },
        {
          "points": [
            { "x": 500, "y": 500 }, { "x": 525, "y": 500 }, { "x": 550, "y": 500 }, { "x": 575, "y": 500 }, { "x": 600, "y": 500 }, { "x": 625, "y": 500 }, { "x": 650, "y": 500 },
            { "x": 675, "y": 500 }, { "x": 700, "y": 500 }, { "x": 725, "y": 500 }, { "x": 750, "y": 500 }, { "x": 775, "y": 500 }, { "x": 800, "y": 500 }, { "x": 825, "y": 500 },
            { "x": 500, "y": 550 }, { "x": 525, "y": 550 }, { "x": 550, "y": 550 }, { "x": 575, "y": 550 }, { "x": 600, "y": 550 }, { "x": 625, "y": 550 }, { "x": 650, "y": 550 },
            { "x": 675, "y": 550 }, { "x": 700, "y": 550 }, { "x": 725, "y": 550 }, { "x": 750, "y": 550 }, { "x": 775, "y": 550 }, { "x": 800, "y": 550 }, { "x": 825, "y": 550 },
            { "x": 500, "y": 600 }, { "x": 525, "y": 600 }, { "x": 550, "y": 600 }, { "x": 575, "y": 600 }, { "x": 600, "y": 600 }, { "x": 625, "y": 600 }, { "x": 650, "y": 600 },
            { "x": 675, "y": 600 }, { "x": 700, "y": 600 }, { "x": 725, "y": 600 }, { "x": 750, "y": 600 }, { "x": 775, "y": 600 }, { "x": 800, "y": 600 }, { "x": 825, "y": 600 },
            { "x": 500, "y": 650 }, { "x": 525, "y": 650 }, { "x": 550, "y": 650 }, { "x": 575, "y": 650 }, { "x": 600, "y": 650 }, { "x": 625, "y": 650 }, { "x": 650, "y": 650 },
            { "x": 675, "y": 650 }, { "x": 700, "y": 650 }, { "x": 725, "y": 650 }, { "x": 750, "y": 650 }, { "x": 775, "y": 650 }, { "x": 800, "y": 650 }, { "x": 825, "y": 650 },
            { "x": 500, "y": 700 }, { "x": 525, "y": 700 }, { "x": 550, "y": 700 }, { "x": 575, "y": 700 }, { "x": 600, "y": 700 }, { "x": 625, "y": 700 }, { "x": 650, "y": 700 },
            { "x": 675, "y": 700 }, { "x": 700, "y": 700 }, { "x": 725, "y": 700 }, { "x": 750, "y": 700 }, { "x": 775, "y": 700 }, { "x": 800, "y": 700 }, { "x": 825, "y": 700 },
            { "x": 500, "y": 750 }, { "x": 525, "y": 750 }, { "x": 550, "y": 750 }, { "x": 575, "y": 750 }, { "x": 600, "y": 750 }, { "x": 625, "y": 750 }, { "x": 650, "y": 750 },
            { "x": 675, "y": 750 }, { "x": 700, "y": 750 }, { "x": 725, "y": 750 }, { "x": 750, "y": 750 }, { "x": 775, "y": 750 }, { "x": 800, "y": 750 }, { "x": 825, "y": 750 },
            { "x": 500, "y": 800 }, { "x": 525, "y": 800 }, { "x": 550, "y": 800 }, { "x": 575, "y": 800 }, { "x": 600, "y": 800 }, { "x": 625, "y": 800 }, { "x": 650, "y": 800 },
            { "x": 675, "y": 800 }, { "x": 700, "y": 800 }, { "x": 725, "y": 800 }, { "x": 750, "y": 800 }, { "x": 775, "y": 800 }, { "x": 800, "y": 800 }, { "x": 825, "y": 800 }
          ]
        }
      ],
      "triangles": [
        [0,1,14],[1,15,14],[1,2,15],[2,16,15],[2,3,16],[3,17,16],[3,4,17],[4,18,17],[4,5,18],[5,19,18],[5,6,19],[6,20,19],[6,7,20],[7,21,20],[7,8,21],[8,22,21],[8,9,22],[9,23,22],[9,10,23],[10,24,23],[10,11,24],[11,25,24],[11,12,25],[12,26,25],[12,13,26],[13,27,26],
        [14,15,28],[15,29,28],[15,16,29],[16,30,29],[16,17,30],[17,31,30],[17,18,31],[18,32,31],[18,19,32],[19,33,32],[19,20,33],[20,34,33],[20,21,34],[21,35,34],[21,22,35],[22,36,35],[22,23,36],[23,37,36],[23,24,37],[24,38,37],[24,25,38],[25,39,38],[25,26,39],[26,40,39],[26,27,40],[27,41,40],
        [28,29,42],[29,43,42],[29,30,43],[30,44,43],[30,31,44],[31,45,44],[31,32,45],[32,46,45],[32,33,46],[33,47,46],[33,34,47],[34,48,47],[34,35,48],[35,49,48],[35,36,49],[36,50,49],[36,37,50],[37,51,50],[37,38,51],[38,52,51],[38,39,52],[39,53,52],[39,40,53],[40,54,53],[40,41,54],[41,55,54],
        [42,43,56],[43,57,56],[43,44,57],[44,58,57],[44,45,58],[45,59,58],[45,46,59],[46,60,59],[46,47,60],[47,61,60],[47,48,61],[48,62,61],[48,49,62],[49,63,62],[49,50,63],[50,64,63],[50,51,64],[51,65,64],[51,52,65],[52,66,65],[52,53,66],[53,67,66],[53,54,67],[54,68,67],[54,55,68],[55,69,68],
        [56,57,70],[57,71,70],[57,58,71],[58,72,71],[58,59,72],[59,73,72],[59,60,73],[60,74,73],[60,61,74],[61,75,74],[61,62,75],[62,76,75],[62,63,76],[63,77,76],[63,64,77],[64,78,77],[64,65,78],[65,79,78],[65,66,79],[66,80,79],[66,67,80],[67,81,80],[67,68,81],[68,82,81],[68,69,82],[69,83,82],
        [70,71,84],[71,85,84],[71,72,85],[72,86,85],[72,73,86],[73,87,86],[73,74,87],[74,88,87],[74,75,88],[75,89,88],[75,76,89],[76,90,89],[76,77,90],[77,91,90],[77,78,91],[78,92,91],[78,79,92],[79,93,92],[79,80,93],[80,94,93],[80,81,94],[81,95,94],[81,82,95],[82,96,95],[82,83,96],[83,97,96]
      ]
    })

  addCustomJson: =>
    json = prompt('Enter custom JSON.')
    try
      x = JSON.parse(json)

      y = {}
      if x.images?
        y.images = [];
        for image, i in y.images
          y.images[i] = {points: []}
        y.triangles = []

      @model.morpher.fromJSON(y, {semiHard: true})

      sleep = (ms) =>
        new Promise (resolve) =>
          setTimeout(resolve, ms)
          return

      sleep(500).then () =>
        @model.morpher.fromJSON(x)
        return
    catch e
      alert('Failed to import data.')

  editBlendFunction: =>
    Gui.Views.Popup.show @blendFunctionView

  editFinalTouchFunction: =>
    Gui.Views.Popup.show @finalTouchFunctionView


  # image views

  addImage: =>
    @model.images.create()

  addImageView: (image) =>
    imageView = new Gui.Views.Image(model: image)
    @imageViews.push imageView
    imageView.on 'drag:stop', @save
    imageView.on 'highlight', @hightlightHandler
    imageView.on 'select', @selectHandler
    @$el.append imageView.render().el
    @arrangeImages()
    if image.isNew()
      imageView.openFile()

  addAllImageViews: =>
    for view in @imageViews
      view.remove()
    @imageViews = []
    @model.images.each(@addImageView)

  removeImageView: (image, collection, params)=>
    @imageViews[params.index].remove()
    delete @imageViews.splice params.index, 1
    @arrangeImages()

  updateImagesSize: (morpher, canvas) =>
    for image in @imageViews
      image.setSize canvas.width, canvas.height

  arrangeImages: =>
    views = @imageViews.slice 0
    views.splice views.length/2, 0, @previewView
    count = views.length
    for image, i in views
      image.setPosition i/count, 0, 1/count, 1

  hightlightHandler: (index, state, midpoint = false) =>
    for image in @imageViews
      image.highlightPoint index, state, midpoint

  selectHandler: (index) =>
    i = @selectedPoints.indexOf(index)
    if i != -1
      @selectedPoints.splice i, 1
    else
      @selectedPoints.push index
    for image in @imageViews
      image.selectPoint index, i == -1


  loadHandler: (morpher, canvas)=>
    @updateImagesSize(morpher, canvas)


  clickHandler: (e) =>
    @[$(e.currentTarget).data('action')]()

  render: =>
    @$menuEl.html @menuTemplate()
    @blendFunctionView.render()
#    @finalTouchFunctionView.render()
    @previewView.render().$el.appendTo @el
    @previewView.$pane.append $('<div />').addClass('artboard').append(@model.morpher.canvas)
    @addAllImageViews()
    this
